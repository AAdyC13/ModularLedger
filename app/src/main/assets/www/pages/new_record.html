<!-- 記一筆頁面 -->
<!-- 上方功能菜單區 -->
<header class="top-menu">
    <nav class="menu-container">
        <button class="menu-btn" id="back-btn">捨棄</button>
        <div class="menu-divider"></div>
        <button class="menu-btn record-type-btn active" id="expense-btn" data-type="0">支出</button>
        <div class="menu-divider"></div>
        <button class="menu-btn record-type-btn" id="income-btn" data-type="1">收入</button>
        <div class="menu-divider"></div>
        <button class="menu-btn record-type-btn" id="transfer-btn" data-type="2">轉帳</button>
        <div class="menu-divider"></div>
        <button class="menu-btn" id="temp-save-btn">暫存</button>
    </nav>
</header>

<!-- 中間主要顯示區塊 -->
<main class="main-content record-main" id="record-main" style="height: 82vh;">
    <div class="record-form" id="record-form">
        <div class="form-group" style="height: 25%;">
            <label for="input-1">時間</label>
            <input type="datetime-local" id="input-1" class="form-input" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-2">金額</label>
            <input type="text" id="input-2" class="form-input" placeholder="請輸入金額" readonly />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-3">類別</label>
            <input type="text" id="input-3" class="form-input" placeholder="請輸入類別" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-4">帳戶</label>
            <input type="text" id="input-4" class="form-input" placeholder="請輸入帳戶" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-5">地點</label>
            <input type="text" id="input-5" class="form-input" placeholder="請輸入地點" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-6">備註</label>
            <input type="text" id="input-6" class="form-input" placeholder="請輸入備註" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-7">輸入7</label>
            <input type="text" id="input-7" class="form-input" placeholder="請輸入內容" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-8">輸入8</label>
            <input type="text" id="input-8" class="form-input" placeholder="請輸入內容" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-9">輸入9</label>
            <input type="text" id="input-9" class="form-input" placeholder="請輸入內容" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-6">備註</label>
            <input type="text" id="input-6" class="form-input" placeholder="請輸入備註" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-7">輸入7</label>
            <input type="text" id="input-7" class="form-input" placeholder="請輸入內容" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-8">輸入8</label>
            <input type="text" id="input-8" class="form-input" placeholder="請輸入內容" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-9">輸入9</label>
            <input type="text" id="input-9" class="form-input" placeholder="請輸入內容" />
        </div>
        <div class="form-group" style="height: 25%;">
            <label for="input-10">輸入10</label>
            <input type="text" id="input-10" class="form-input" placeholder="請輸入內容" />
        </div>
    </div>
    <div class="record-scrollbar">
        <div class="record-scrollbar-thumb" id="record-scrollbar-thumb"></div>
    </div>
</main>

<!-- 計算機將從 calculator.html 動態載入 -->
<div id="calculator-mount-point"></div>

<!-- 下方功能菜單區 -->
<footer class="bottom-menu record-footer">
    <nav class="menu-container" style="grid-template-columns: 1fr auto 1fr;">
        <button class="menu-btn" id="save-btn">儲存</button>
        <div class="menu-divider"></div>
        <button class="menu-btn" id="add-another-btn">再記一筆</button>
    </nav>
</footer>
</div>

<script>
    // 將 new_record.html 的腳本包裹在 IIFE 中，避免變數衝突
    (function () {
        // 記錄類型變數：0=支出, 1=收入, 2=轉帳
        let newRecordType = 0;

        // 載入計算機組件
        fetch('../components/Calculator.html')
            .then(response => response.text())
            .then(html => {
                const mountPoint = document.getElementById('calculator-mount-point');
                mountPoint.innerHTML = html;

                // 執行計算機內嵌的腳本
                const scripts = mountPoint.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                    script.remove();
                });

                // 初始化計算機
                if (window.Calculator) {
                    window.Calculator.init('input-2');
                }
            })
            .catch(error => console.error('載入計算機失敗:', error));

        const backBtn = document.getElementById('back-btn');

        backBtn.addEventListener('click', function (e) {
            e.preventDefault();

            // 檢查是否在頁面容器中
            const pageContainer = this.closest('.page-container');
            if (pageContainer) {
                // 使用動畫關閉
                pageContainer.classList.add('closing');
                pageContainer.classList.remove('active');
                setTimeout(() => {
                    pageContainer.remove();
                    history.back();
                }, 400);
            } else {
                // 使用路由返回
                if (window.appRouter) {
                    window.appRouter.back();
                }
            }
        });

        const saveBtn = document.getElementById('save-btn');
        const addAnotherBtn = document.getElementById('add-another-btn');

        saveBtn.addEventListener('click', function (e) {
            e.preventDefault();
            console.log('儲存記錄');
            // TODO: 實作儲存邏輯
        });

        addAnotherBtn.addEventListener('click', function (e) {
            e.preventDefault();
            console.log('再記一筆');
            // TODO: 清空表單或重新載入
        });

        // 更新記錄類型按鈕的視覺狀態
        function updateRecordTypeButtons() {
            document.querySelectorAll('.record-type-btn').forEach(btn => {
                const btnType = parseInt(btn.dataset.type);
                if (btnType === newRecordType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // 記錄類型按鈕事件
        document.querySelectorAll('.record-type-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                newRecordType = parseInt(this.dataset.type);
                updateRecordTypeButtons();
                console.log('切換記錄類型:', newRecordType);
            });
        });

        // 暫存按鈕事件
        document.getElementById('temp-save-btn').addEventListener('click', function (e) {
            e.preventDefault();
            console.log('暫存記錄, 當前類型:', newRecordType);
            // TODO: 實作暫存邏輯
        });

        // 自定義滾動實現
        const recordMain = document.getElementById('record-main');
        const recordForm = document.getElementById('record-form');
        const recordScrollbarThumb = document.getElementById('record-scrollbar-thumb');

        let isDragging = false;
        let startY = 0;
        let scrollTop = 0;
        let contentHeight = 0;
        let containerHeight = 0;
        let maxScroll = 0;

        function updateScrollbar() {
            contentHeight = recordForm.scrollHeight;
            containerHeight = recordMain.clientHeight;
            maxScroll = Math.max(0, contentHeight - containerHeight);

            if (maxScroll > 0) {
                const thumbHeight = Math.max(30, (containerHeight / contentHeight) * containerHeight);
                const thumbTop = (Math.abs(scrollTop) / maxScroll) * (containerHeight - thumbHeight);
                recordScrollbarThumb.style.height = thumbHeight + 'px';
                recordScrollbarThumb.style.top = thumbTop + 'px';
            }
        }

        recordMain.addEventListener('mousedown', function (e) {
            if (e.target.closest('.form-input')) return;
            isDragging = true;
            startY = e.clientY;
            scrollTop = parseFloat(recordForm.style.top || 0);
            recordMain.classList.add('dragging');
            e.preventDefault();
        });

        recordMain.addEventListener('touchstart', function (e) {
            if (e.target.closest('.form-input')) return;
            isDragging = true;
            startY = e.touches[0].clientY;
            scrollTop = parseFloat(recordForm.style.top || 0);
            recordMain.classList.add('dragging');
        }, { passive: true });

        document.addEventListener('mousemove', function (e) {
            if (!isDragging) return;
            const deltaY = e.clientY - startY;
            const newScrollTop = Math.max(-maxScroll, Math.min(0, scrollTop + deltaY));
            recordForm.style.top = newScrollTop + 'px';
            scrollTop = newScrollTop;
            updateScrollbar();
        });

        document.addEventListener('touchmove', function (e) {
            if (!isDragging) return;
            const deltaY = e.touches[0].clientY - startY;
            const newScrollTop = Math.max(-maxScroll, Math.min(0, scrollTop + deltaY));
            recordForm.style.top = newScrollTop + 'px';
            scrollTop = newScrollTop;
            updateScrollbar();
        }, { passive: true });

        document.addEventListener('mouseup', function () {
            if (isDragging) {
                isDragging = false;
                recordMain.classList.remove('dragging');
            }
        });

        document.addEventListener('touchend', function () {
            if (isDragging) {
                isDragging = false;
                recordMain.classList.remove('dragging');
            }
        });

        recordMain.addEventListener('wheel', function (e) {
            e.preventDefault();
            const delta = e.deltaY;
            const newScrollTop = Math.max(-maxScroll, Math.min(0, scrollTop - delta));
            recordForm.style.top = newScrollTop + 'px';
            scrollTop = newScrollTop;
            updateScrollbar();
        }, { passive: false });

        const observer = new ResizeObserver(() => {
            updateScrollbar();
        });
        observer.observe(recordMain);
        observer.observe(recordForm);

        updateScrollbar();
    })(); // 結束 IIFE
</script>